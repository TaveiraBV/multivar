function xP = filtro_kalman_estendido(v)

I = eye(3);

u = v(1);
y = [v(2) ; v(3)];

P_old = [v(4) v(5) v(6);
         v(7) v(8) v(9);
         v(10) v(11) v(12)];
     
x_old = [v(13); v(14); v(15)];     

% Matriz de saida
C = [1 1 1; 1 1 1];   

% Periodo de amostragem
Ts = 0.001;           

% Parametros do Filtro de Kalman Estendido (P0 = 100000000*[1; 0; 0; 0; 1; 0; 0; 0; 1])
V1 = diag([100000 1 0.01]);   
r = 0.1; 
V2 = r*diag([1 0.85*1000]);

% Measurement update
L = (P_old * C') / (C*P_old*C'+V2);
x = x_old + L * (y - C*x_old);
P = (I-L*C)*P_old;

x1 = x(1);
x2 = x(2);
x3 = x(3);

pf1 = (0.2597*cos(x1))/(0.00010052083333333333497409262102806*cos(x2)^2 + 0.0002*sin(x2)^2 + 0.00231);
pf2 = (u*(0.113*sin(x2) - 0.00019895833333333334922050916748759*x3*cos(x2)^2 + 0.00019895833333333334922050916748759*x3*sin(x2)^2))/(0.00010052083333333333497409262102806*cos(x2)^2 + 0.0002*sin(x2)^2 + 0.0023100000000000000200187089127724) - (0.000051669479166666665814456292638024*cos(x2)*sin(x1)*sin(x2))/(0.00010052083333333333497409262102806*cos(x2)^2 + 0.0002*sin(x2)^2 + 0.00231)^2 + (0.00019895833333333333005181475794387*u*cos(x2)*sin(x2)*(0.113*cos(x2) + 0.00019895833333333334922050916748759*x3*cos(x2)*sin(x2)))/(0.00010052083333333333497409262102806*cos(x2)^2 + 0.0002*sin(x2)^2 + 0.0023100000000000000200187089127724)^2;
pf3 = -(0.00019895833333333334922050916748759*u*cos(x2)*sin(x2))/(0.00010052083333333333497409262102806*cos(x2)^2 + 0.0002*sin(x2)^2 + 0.0023100000000000000200187089127724);

partialx = [0 0 1; 0 0 0; pf1 pf2 pf3];  

Ak = eye(3) + Ts * partialx; 

% Time update
x = x + Ts * [x3; u; (0.2597*sin(x1))/(0.00010052083333333333497409262102806*cos(x2)^2 + 0.0002*sin(x2)^2 + 0.00231) - (1.0*u*(0.113*cos(x2) + 0.00019895833333333334922050916748759*x3*cos(x2)*sin(x2)))/(0.00010052083333333333497409262102806*cos(x2)^2 + 0.0002*sin(x2)^2 + 0.0023100000000000000200187089127724)];
P = Ak * P * Ak' + V1;
xP = [x(1); x(2); x(3); P(1,1); P(1,2); P(1,3); P(2,1); P(2,2); P(2,3); P(3,1); P(3,2); P(3,3)];

end
